<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Mutations | Relay Docs</title><meta name="viewport" content="width=device-width"><meta property="og:title" content="Mutations | Relay Docs"><meta property="og:type" content="website"><meta property="og:url" content="http://facebook.github.io/relay/index.html"><meta property="og:description" content="A JavaScript framework for building data-driven React applications"><link rel="shortcut icon" href="/relay/img/favicon.png"><link rel="stylesheet" href="/relay/css/relay.css"><script type="text/javascript" src="//use.typekit.net/vqa1hcx.js"></script><script type="text/javascript">try{Typekit.load();}catch(e){}</script></head><body><div class="container"><div class="nav-main"><div class="wrap"><a class="nav-home" href="/relay/"><img class="nav-logo" src="/relay/img/logo.svg" width="50" height="50">Relay</a><ul class="nav-site"><li><a href="/relay/prototyping/playground.html" class="">Try it out</a></li><li><a href="/relay/docs/getting-started.html#content" class="active">Docs</a></li><li><a href="/relay/support.html" class="">Support</a></li><li><a href="https://github.com/facebook/relay" class="">GitHub</a></li></ul></div></div><section class="content wrap documentationContent"><div class="nav-docs"><div class="nav-docs-section"><h3>Quick Start</h3><ul><li><a style="margin-left:0;" class="" href="/relay/docs/getting-started.html#content">Getting Started</a></li><li><a style="margin-left:0;" class="" href="/relay/docs/tutorial.html#content">Tutorial</a></li><li><a style="margin-left:0;" class="" href="/relay/docs/thinking-in-graphql.html#content">Thinking in GraphQL</a></li><li><a style="margin-left:0;" class="" href="/relay/docs/thinking-in-relay.html#content">Thinking In Relay</a></li><li><a style="margin-left:0;" class="" href="/relay/docs/videos.html#content">Videos</a></li></ul></div><div class="nav-docs-section"><h3>Guides</h3><ul><li><a style="margin-left:0;" class="" href="/relay/docs/guides-containers.html#content">Containers</a></li><li><a style="margin-left:0;" class="" href="/relay/docs/guides-routes.html#content">Routes</a></li><li><a style="margin-left:0;" class="" href="/relay/docs/guides-root-container.html#content">Root Container</a></li><li><a style="margin-left:0;" class="" href="/relay/docs/guides-ready-state.html#content">Ready State</a></li><li><a style="margin-left:0;" class="active" href="/relay/docs/guides-mutations.html#content">Mutations</a></li><li><a style="margin-left:0;" class="" href="/relay/docs/guides-network-layer.html#content">Network Layer</a></li><li><a style="margin-left:0;" class="" href="/relay/docs/guides-babel-plugin.html#content">Babel Relay Plugin</a></li></ul></div><div class="nav-docs-section"><h3>GraphQL</h3><ul><li><a style="margin-left:0;" class="" href="/relay/docs/graphql-relay-specification.html#content">GraphQL Relay Specification</a></li><li><a style="margin-left:20px;" class="" href="/relay/docs/graphql-object-identification.html#content">Object Identification</a></li><li><a style="margin-left:20px;" class="" href="/relay/docs/graphql-connections.html#content">Connection</a></li><li><a style="margin-left:20px;" class="" href="/relay/docs/graphql-mutations.html#content">Mutations</a></li><li><a style="margin-left:20px;" class="" href="/relay/docs/graphql-further-reading.html#content">Further Reading</a></li></ul></div><div class="nav-docs-section"><h3>API Reference</h3><ul><li><a style="margin-left:0;" class="" href="/relay/docs/api-reference-relay.html#content">Relay</a></li><li><a style="margin-left:0;" class="" href="/relay/docs/api-reference-relay-container.html#content">RelayContainer</a></li><li><a style="margin-left:0;" class="" href="/relay/docs/api-reference-relay-route.html#content">Relay.Route</a></li><li><a style="margin-left:0;" class="" href="/relay/docs/api-reference-relay-renderer.html#content">Relay.Renderer</a></li><li><a style="margin-left:0;" class="" href="/relay/docs/api-reference-relay-root-container.html#content">Relay.RootContainer</a></li><li><a style="margin-left:0;" class="" href="/relay/docs/api-reference-relay-ql.html#content">Relay.QL</a></li><li><a style="margin-left:0;" class="" href="/relay/docs/api-reference-relay-mutation.html#content">Relay.Mutation</a></li><li><a style="margin-left:0;" class="" href="/relay/docs/api-reference-relay-graphql-mutation.html#content">Relay.GraphQLMutation</a></li><li><a style="margin-left:0;" class="" href="/relay/docs/api-reference-relay-proptypes.html#content">Relay.PropTypes</a></li><li><a style="margin-left:0;" class="" href="/relay/docs/api-reference-relay-store.html#content">Relay.Store</a></li></ul></div><div class="nav-docs-section"><h3>Interfaces</h3><ul><li><a style="margin-left:0;" class="" href="/relay/docs/interfaces-relay-network-layer.html#content">RelayNetworkLayer</a></li><li><a style="margin-left:20px;" class="" href="/relay/docs/interfaces-relay-mutation-request.html#content">RelayMutationRequest</a></li><li><a style="margin-left:20px;" class="" href="/relay/docs/interfaces-relay-query-request.html#content">RelayQueryRequest</a></li></ul></div></div><div class="inner-content"><a id="content"></a><a class="edit-page-link" href="https://github.com/facebook/relay/blob/master/docs/Guides-Mutations.md" target="_blank">Edit on GitHub</a><h1>Mutations</h1><div><p>到目前為止，我們只有跟 GraphQL endpoint 互動去執行抓取資料的 query。在這份指南中，你將會學習到如何使用 Relay 去執行 mutation – 這個操作包括寫入到資料 store 並隨後抓取任何改變的欄位。</p><h2><a class="anchor" name=""></a>完整的範例 <a class="hash-link" href="#">#</a></h2><p>在我們深入 mutation API 之前，讓我們先看一個完整的範例。在這裡，我們繼承 <code>Relay.Mutation</code> 來建立一個可以用來 like story 的客製化 mutation。</p><pre class="prism language-javascript">
<span class="token keyword">class</span> <span class="token class-name">LikeStoryMutation</span> <span class="token keyword">extends</span> <span class="token class-name">Relay<span class="token punctuation">.</span>Mutation</span> <span class="token punctuation">{</span>
  <span spellcheck="true" class="token comment">// 這個方法應該回傳一個 GraphQL 操作來代表</span>
  <span spellcheck="true" class="token comment">// 要被執行的 mutation。這裡假設伺服器</span>
  <span spellcheck="true" class="token comment">// 實作了一個叫做 ‘likeStory’ 的 mutation type。</span>
  <span class="token function">getMutation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Relay<span class="token punctuation">.</span>QL<span class="token template-string"><span class="token string">`mutation {likeStory}`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span spellcheck="true" class="token comment">// 使用這個方法來準備要給 mutation 作為</span>
  <span spellcheck="true" class="token comment">// input 的變數。我們的 ‘likeStory’ mutation 剛好接收</span>
  <span spellcheck="true" class="token comment">// 一個變數作為 input – 要 like 的 story 的 ID。</span>
  <span class="token function">getVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>storyID<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>story<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span spellcheck="true" class="token comment">// 使用這個方法來設計一個 ‘fat query’ – 一個代表在你的資料模型中每個</span>
  <span spellcheck="true" class="token comment">// 可能會因為這個 mutation 而改變的欄位。</span>
  <span spellcheck="true" class="token comment">// Like 一個 story 可能會影響 liker 的數量，</span>
  <span spellcheck="true" class="token comment">// 一個總結有誰 like 這個 story 的句子，還有正在觀看的人有沒有 like</span>
  <span spellcheck="true" class="token comment">// 這個 story。Relay 會用一個代表應用程式實際使用資料</span>
  <span spellcheck="true" class="token comment">// 的 ‘tracked query’ 來取交集做出這個 query，並</span>
  <span spellcheck="true" class="token comment">// 指示伺服器只把這些欄位加進它的回應中。</span>
  <span class="token function">getFatQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Relay<span class="token punctuation">.</span>QL<span class="token template-string"><span class="token string">`
      fragment on LikeStoryPayload {
        story {
          likers {
            count,
          },
          likeSentence,
          viewerDoesLike,
        },
      }
    `</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span spellcheck="true" class="token comment">// 這些設定建議 Relay 要如何處理伺服器回傳的</span>
  <span spellcheck="true" class="token comment">// LikeStoryPayload。下面，我們告訴 Relay 使用這個 payload 去</span>
  <span spellcheck="true" class="token comment">// 改變已經在 store 裡面的 record 的欄位。</span>
  <span spellcheck="true" class="token comment">// ‘fieldIDs’ 鍵值對把在 payload 中的欄位名稱關聯到</span>
  <span spellcheck="true" class="token comment">// 我們想要更新的 record 的 ID。</span>
  <span class="token function">getConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> <span class="token string">&#x27;FIELDS_CHANGE&#x27;</span><span class="token punctuation">,</span>
      fieldIDs<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        story<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>story<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span spellcheck="true" class="token comment">// 這個 mutation 對 story 的 ID 有一個強硬的依賴關係。我們在這裡宣告式的</span>
  <span spellcheck="true" class="token comment">// 指定這個依賴關係作為一個 GraphQL query fragment。Relay 會</span>
  <span spellcheck="true" class="token comment">// 使用這個 fragment 來確保無論這個 mutation 在哪被使用</span>
  <span spellcheck="true" class="token comment">// 這個 story 的 ID 都可以使用。</span>
  <span class="token keyword">static</span> fragments <span class="token operator">=</span> <span class="token punctuation">{</span>
    story<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> Relay<span class="token punctuation">.</span>QL<span class="token template-string"><span class="token string">`
      fragment on Story {
        id,
      }
    `</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre><p>下面是這個 mutation 被 <code>LikeButton</code> component 使用的範例：</p><pre class="prism language-javascript">
<span class="token keyword">class</span> <span class="token class-name">LikeButton</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  _handleLike <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span spellcheck="true" class="token comment">// 要執行 mutation，必須傳遞一個 mutation 的實體給</span>
    <span spellcheck="true" class="token comment">// `this.props.relay.commitUpdate`</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>relay<span class="token punctuation">.</span><span class="token function">commitUpdate</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">LikeStoryMutation</span><span class="token punctuation">(</span><span class="token punctuation">{</span>story<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>story<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>story<span class="token punctuation">.</span>viewerDoesLike
          <span class="token operator">?</span> <span class="token string">&#x27;You like this&#x27;</span>
          <span class="token punctuation">:</span> <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>_handleLike<span class="token punctuation">}</span><span class="token operator">&gt;</span>Like <span class="token keyword">this</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Relay<span class="token punctuation">.</span><span class="token function">createContainer</span><span class="token punctuation">(</span>LikeButton<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  fragments<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span spellcheck="true" class="token comment">// 你可以像你其他的那些 RelayContainer 一般</span>
    <span spellcheck="true" class="token comment">// 合成 mutation 的 query fragment。這可以確保</span>
    <span spellcheck="true" class="token comment">// mutation 依賴的資料會先被抓取並準備好可以使用。</span>
    story<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> Relay<span class="token punctuation">.</span>QL`
      fragment on Story <span class="token punctuation">{</span>
        viewerDoesLike<span class="token punctuation">,</span>
        $<span class="token punctuation">{</span>LikeStoryMutation<span class="token punctuation">.</span><span class="token function">getFragment</span><span class="token punctuation">(</span><span class="token string">&#x27;story&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    `<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><p>在這個特定的例子中，<code>LikeButton</code> 唯一在意的欄位是 <code>viewerDoesLike</code>。那個欄位會成為 tracked query 的一部分，Relay 會用它跟 <code>LikeStoryMutation</code> 的 fat query 取交集，以決定針對這個 mutation 要請求什麼欄位作為伺服器回應 payload 的一部份。應用程式中別處的其他 component 可能也對 likers count，或是 like sentence 感興趣。由於這些欄位會自動地被加進 Relay 的 tracked query，<code>LikeButton</code> 不需要擔心需要明確地請求它們。</p><h2><a class="anchor" name="mutation-props"></a>Mutation props <a class="hash-link" href="#mutation-props">#</a></h2><p>我們傳遞給 mutation constructor 的任何 props 可以在它的實體方法藉由 <code>this.props</code> 取用。就像在 Relay container 裡面使用的 component 中，那些有對應定義過的 fragment 的 props 會被 Relay 用 query 的資料填入：</p><pre class="prism language-javascript">
<span class="token keyword">class</span> <span class="token class-name">LikeStoryMutation</span> <span class="token keyword">extends</span> <span class="token class-name">Relay<span class="token punctuation">.</span>Mutation</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> fragments <span class="token operator">=</span> <span class="token punctuation">{</span>
    story<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> Relay<span class="token punctuation">.</span>QL<span class="token template-string"><span class="token string">`
      fragment on Story {
        id,
        viewerDoesLike,
      }
    `</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">getMutation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span spellcheck="true" class="token comment">// 在這裡，viewerDoesLike 是保證可以使用的。</span>
    <span spellcheck="true" class="token comment">// 我們可以用它來讓這個 mutation 有點變化。</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>story<span class="token punctuation">.</span>viewerDoesLike
      <span class="token operator">?</span> Relay<span class="token punctuation">.</span>QL<span class="token template-string"><span class="token string">`mutation {unlikeStory}`</span></span>
      <span class="token punctuation">:</span> Relay<span class="token punctuation">.</span>QL<span class="token template-string"><span class="token string">`mutation {likeStory}`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span spellcheck="true" class="token comment">/* ... */</span>
<span class="token punctuation">}</span></pre><h2><a class="anchor" name="fragment"></a>Fragment 變數 <a class="hash-link" href="#fragment">#</a></h2><p>就像 <a href="guides-containers.html" target="_blank">Relay containers</a> 一樣，我們可以基於先前的變數和執行期環境，準備變數給我們的 mutation 的 fragment builder 使用。</p><pre class="prism language-javascript">
<span class="token keyword">class</span> <span class="token class-name">RentMovieMutation</span> <span class="token keyword">extends</span> <span class="token class-name">Relay<span class="token punctuation">.</span>Mutation</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> initialVariables <span class="token operator">=</span> <span class="token punctuation">{</span>
    format<span class="token punctuation">:</span> <span class="token string">&#x27;hd&#x27;</span><span class="token punctuation">,</span>
    lang<span class="token punctuation">:</span> <span class="token string">&#x27;en-CA&#x27;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> prepareVariables <span class="token operator">=</span> <span class="token punctuation">(</span>prevVariables<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> overrideVariables <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>language<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      overrideVariables<span class="token punctuation">.</span>lang <span class="token operator">=</span> navigator<span class="token punctuation">.</span>language<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> formatPreference <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&#x27;formatPreference&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>formatPreference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      overrideVariables<span class="token punctuation">.</span>format <span class="token operator">=</span> formatPreference<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>prevVariables<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>overrideVariables<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> fragments <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span spellcheck="true" class="token comment">// 現在我們可以使用這些我們準備用來抓取 movie 的變數</span>
    <span spellcheck="true" class="token comment">// 分配適合正在觀看的人的語言環境和喜好設定</span>
    movie<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> Relay<span class="token punctuation">.</span>QL<span class="token template-string"><span class="token string">`
      fragment on Movie {
        posterImage(lang: $lang) { url },
        trailerVideo(format: $format, lang: $lang) { url },
      }
    `</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre><h2><a class="anchor" name="fat-query"></a>fat query <a class="hash-link" href="#fat-query">#</a></h2><p>在系統中改變一個東西，可能會造成其他東西接著改變的連鎖反應。想像一個我們可以用來接受好友邀請的 mutation。這可能造成廣泛的影響：</p><ul><li>兩個人的 friend count 都將增加</li><li>一個代表這個新的 friend 的 edge 會被添加到 viewer 的 <code>friends</code> connection</li><li>一個代表 viewer 的 edge 會被添加到這個新的 friend 的 <code>friends</code> connection</li><li>viewer 與 requester 的 friendship 狀態會改變</li></ul><p>設計一個涵蓋所有可能會改變的欄位的 fat query：</p><pre class="prism language-javascript">
<span class="token keyword">class</span> <span class="token class-name">AcceptFriendRequestMutation</span> <span class="token keyword">extends</span> <span class="token class-name">Relay<span class="token punctuation">.</span>Mutation</span> <span class="token punctuation">{</span>
  <span class="token function">getFatQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span spellcheck="true" class="token comment">// 這假設這個 mutation 的伺服器端實作</span>
    <span spellcheck="true" class="token comment">// 回傳一個 type `AcceptFriendRequestPayload` 的 payload，它包含</span>
    <span spellcheck="true" class="token comment">// `friendEdge`、`friendRequester`、和 `viewer` 欄位。</span>
    <span class="token keyword">return</span> Relay<span class="token punctuation">.</span>QL<span class="token template-string"><span class="token string">`
      fragment on AcceptFriendRequestPayload {
        friendEdge,
        friendRequester {
          friends,
          friendshipStatusWithViewer,
        },
        viewer {
          friends,
        },
      }
    `</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre><p>這個 fat query 看起來就像其他的 GraphQL query，但是有一個重要的不同。我們知道這之中的某些欄位不是 scalar (像是 <code>friendEdge</code> 和 <code>friends</code>)，
但是請注意，我們沒有經由 subquery 命名它們的任何 children。透過這種方式，我們暗示 Relay 在這些不是 scalar 的欄位之下的<em>任何東西</em>都可能會因為這個 mutation 而改變。</p><blockquote><p>附註</p><p>在設計 fat query 時，要考慮<em>所有</em>可能會因為 mutation 而改變的資料 – 不只是應用程式正在使用的資料。我們不需要擔心抓取了多餘的東西；這個 query 會與我們的應用程式實際上需要的資料的 ‘tracked query’ 取交集才執行。如果我們在 fat query 中忽略了任何欄位，我們可能會在未來添加新的 view 與資料依賴關係，或是添加新的資料依賴關係到既有的 view 時觀察到資料不一致。</p></blockquote><h2><a class="anchor" name="mutator"></a>設定 Mutator <a class="hash-link" href="#mutator">#</a></h2><p>我們需要給 Relay 如何從每一個 mutation 使用回應 payload 來更新客戶端的 store 的指示。我們透過用一個以上下述的 mutation type 去設定 mutation 來達成：</p><h3><a class="anchor" name="fields-change"></a><code>FIELDS_CHANGE</code> <a class="hash-link" href="#fields-change">#</a></h3><p>任何在 payload 中的欄位，如果可以透過 DataID 關聯到一個以上在客戶端的 store 中的 record，就會跟在 store 中的 record 合併。</p><h4><a class="anchor" name="fields-change"></a>參數 <a class="hash-link" href="#fields-change">#</a></h4><ul><li><p><code>fieldIDs: {[fieldName: string]: DataID | Array&lt;DataID&gt;}</code></p><p>一個把回應中的 <code>fieldName</code> 映射到一個以上在 store 中的 DataID 的 map。</p></li></ul><h4><a class="anchor" name="fields-change"></a>範例 <a class="hash-link" href="#fields-change">#</a></h4><pre class="prism language-javascript">
<span class="token keyword">class</span> <span class="token class-name">RenameDocumentMutation</span> <span class="token keyword">extends</span> <span class="token class-name">Relay<span class="token punctuation">.</span>Mutation</span> <span class="token punctuation">{</span>
  <span spellcheck="true" class="token comment">// 這個 mutation 宣告一個依賴關係在 document 的 ID 上</span>
  <span class="token keyword">static</span> fragments <span class="token operator">=</span> <span class="token punctuation">{</span>
    document<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> Relay<span class="token punctuation">.</span>QL<span class="token template-string"><span class="token string">`fragment on Document { id }`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span spellcheck="true" class="token comment">// 我們知道只有這個 document 的 name 有可能因為</span>
  <span spellcheck="true" class="token comment">// 這個 mutation 而改變，所以把它指定在這裡的 fat query 中。</span>
  <span class="token function">getFatQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Relay<span class="token punctuation">.</span>QL<span class="token template-string"><span class="token string">`
      fragment on RenameDocumentMutationPayload { updatedDocument { name } }
    `</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">getVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>document<span class="token punctuation">.</span>id<span class="token punctuation">,</span> newName<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>newName<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">getConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> <span class="token string">&#x27;FIELDS_CHANGE&#x27;</span><span class="token punctuation">,</span>
      <span spellcheck="true" class="token comment">// 把在回應中的 `updatedDocument` 欄位關聯</span>
      <span spellcheck="true" class="token comment">// 到我們想要更新的 record 的 DataID。</span>
      fieldIDs<span class="token punctuation">:</span> <span class="token punctuation">{</span>updatedDocument<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>document<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span spellcheck="true" class="token comment">/* ... */</span>
<span class="token punctuation">}</span></pre><h3><a class="anchor" name="node-delete"></a><code>NODE_DELETE</code> <a class="hash-link" href="#node-delete">#</a></h3><p>給定一個 parent、一個 connection、和一個以上的 DataID 在回應的 payload 中，Relay 會從 connection 移除這個 node 並從 store 刪除相關的 record。</p><h4><a class="anchor" name="node-delete"></a>參數 <a class="hash-link" href="#node-delete">#</a></h4><ul><li><p><code>parentName: string</code></p><p>在回應中代表這個 connection 的 parent 的欄位名稱</p></li><li><p><code>parentID: string</code></p><p>包含這個 connection 的 parent node 的 DataID</p></li><li><p><code>connectionName: string</code></p><p>在回應中代表這個 connection 的欄位名稱</p></li><li><p><code>deletedIDFieldName: string</code></p><p>在回應中包含 deleted node 的 DataID 的欄位名稱</p></li></ul><h4><a class="anchor" name="node-delete"></a>範例 <a class="hash-link" href="#node-delete">#</a></h4><pre class="prism language-javascript">
<span class="token keyword">class</span> <span class="token class-name">DestroyShipMutation</span> <span class="token keyword">extends</span> <span class="token class-name">Relay<span class="token punctuation">.</span>Mutation</span> <span class="token punctuation">{</span>
  <span spellcheck="true" class="token comment">// 這個 mutation 宣告一個依賴關係在一個敵軍的 ship 的 ID</span>
  <span spellcheck="true" class="token comment">// 和 ship 屬於的 faction 的 ID 上。</span>
  <span class="token keyword">static</span> fragments <span class="token operator">=</span> <span class="token punctuation">{</span>
    ship<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> Relay<span class="token punctuation">.</span>QL<span class="token template-string"><span class="token string">`fragment on Ship { id, faction { id } }`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span spellcheck="true" class="token comment">// Destroy 一個 ship 會從一個 faction 的 fleet 移除它，因此我們</span>
  <span spellcheck="true" class="token comment">// 指定這個 faction 的 ships connection 作為 fat query 的一部份。</span>
  <span class="token function">getFatQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Relay<span class="token punctuation">.</span>QL<span class="token template-string"><span class="token string">`
      fragment on DestroyShipMutationPayload {
        destroyedShipID,
        faction { ships },
      }
    `</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">getConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> <span class="token string">&#x27;NODE_DELETE&#x27;</span><span class="token punctuation">,</span>
      parentName<span class="token punctuation">:</span> <span class="token string">&#x27;faction&#x27;</span><span class="token punctuation">,</span>
      parentID<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>ship<span class="token punctuation">.</span>faction<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      connectionName<span class="token punctuation">:</span> <span class="token string">&#x27;ships&#x27;</span><span class="token punctuation">,</span>
      deletedIDFieldName<span class="token punctuation">:</span> <span class="token string">&#x27;destroyedShipID&#x27;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span spellcheck="true" class="token comment">/* ... */</span>
<span class="token punctuation">}</span></pre><h3><a class="anchor" name="range-add"></a><code>RANGE_ADD</code> <a class="hash-link" href="#range-add">#</a></h3><p>在回應 payload 中給定一個 parent、一個 connection、和新建立的 edge 的名稱，Relay 將會把這個 node 添加到 store 並依照指定的 range behavior 把它附加到這個 connection。</p><h4><a class="anchor" name="range-add"></a>參數 <a class="hash-link" href="#range-add">#</a></h4><ul><li><p><code>parentName: string</code></p><p>在回應中代表這個 connection 的 parent 的欄位名稱</p></li><li><p><code>parentID: string</code></p><p>包含這個 connection 的 parent node 的 DataID</p></li><li><p><code>connectionName: string</code></p><p>在回應中代表這個 connection 的欄位名稱</p></li><li><p><code>edgeName: string</code></p><p>在回應中代表新建立的 edge 的欄位名稱</p></li><li><p><code>rangeBehaviors: {[call: string]: GraphQLMutatorConstants.RANGE_OPERATIONS} | (connectionArgs: {[argName: string]: string}) =&gt; $Enum&lt;GraphQLMutatorConstants.RANGE_OPERATIONS&gt;</code></p><p>一個 printed、dot-separated <em>依字母順序</em>的 GraphQL calls 以及我們想要 Relay 在這些 calls 的影響下添加新的 edge 到 connections 表現的 behavior 之間的 map 或是一個接收一個 connection 參數的陣列，回傳那個 behavior 的 function。</p></li></ul><p>例如，可以用這種方式撰寫 <code>rangeBehaviors</code>：</p><pre class="prism language-javascript">
<span class="token keyword">const</span> rangeBehaviors <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span spellcheck="true" class="token comment">// 當這些 ships connection 沒有受到任何 call 的影響</span>
  <span spellcheck="true" class="token comment">// ，把 ship 附加到這個 connection 的尾端</span>
  <span class="token string">&#x27;&#x27;</span><span class="token punctuation">:</span> <span class="token string">&#x27;append&#x27;</span><span class="token punctuation">,</span>
  <span spellcheck="true" class="token comment">// 在這個 connection 依照時間排序時，把這個 ship 附加到前端</span>
  <span class="token string">&#x27;orderby(newest)&#x27;</span><span class="token punctuation">:</span> <span class="token string">&#x27;prepend&#x27;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></pre><p>或是用這種方式，會得到一樣的結果：</p><pre class="prism language-javascript">
<span class="token keyword">const</span> rangeBehaviors <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>orderby<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>orderby <span class="token operator">===</span> <span class="token string">&#x27;newest&#x27;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&#x27;prepend&#x27;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&#x27;append&#x27;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></pre><p>Behaviors 可以是 <code>&#x27;append&#x27;</code>、<code>&#x27;ignore&#x27;</code>、<code>&#x27;prepend&#x27;</code>、<code>&#x27;refetch&#x27;</code>、或是 <code>&#x27;remove&#x27;</code> 的其中一個。</p><h4><a class="anchor" name="range-add"></a>範例 <a class="hash-link" href="#range-add">#</a></h4><pre class="prism language-javascript">
<span class="token keyword">class</span> <span class="token class-name">IntroduceShipMutation</span> <span class="token keyword">extends</span> <span class="token class-name">Relay<span class="token punctuation">.</span>Mutation</span> <span class="token punctuation">{</span>
  <span spellcheck="true" class="token comment">// 這個 mutation 宣告一個依賴關係在</span>
  <span spellcheck="true" class="token comment">// 這個 ship 要被 introduce 進去的 faction 上。</span>
  <span class="token keyword">static</span> fragments <span class="token operator">=</span> <span class="token punctuation">{</span>
    faction<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> Relay<span class="token punctuation">.</span>QL<span class="token template-string"><span class="token string">`fragment on Faction { id }`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span spellcheck="true" class="token comment">// Introduce 一個 ship 會把它添加到 faction 的 fleet，因此我們</span>
  <span spellcheck="true" class="token comment">// 指定這個 faction 的 ships connection 作為 fat query 的一部份。</span>
  <span class="token function">getFatQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Relay<span class="token punctuation">.</span>QL<span class="token template-string"><span class="token string">`
      fragment on IntroduceShipPayload {
        faction { ships },
        newShipEdge,
      }
    `</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">getConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> <span class="token string">&#x27;RANGE_ADD&#x27;</span><span class="token punctuation">,</span>
      parentName<span class="token punctuation">:</span> <span class="token string">&#x27;faction&#x27;</span><span class="token punctuation">,</span>
      parentID<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>faction<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      connectionName<span class="token punctuation">:</span> <span class="token string">&#x27;ships&#x27;</span><span class="token punctuation">,</span>
      edgeName<span class="token punctuation">:</span> <span class="token string">&#x27;newShipEdge&#x27;</span><span class="token punctuation">,</span>
      rangeBehaviors<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span spellcheck="true" class="token comment">// 當這些 ships connection 沒有受到任何 call 的影響，</span>
        <span spellcheck="true" class="token comment">// 把 ship 附加到這個 connection 的尾端</span>
        <span class="token string">&#x27;&#x27;</span><span class="token punctuation">:</span> <span class="token string">&#x27;append&#x27;</span><span class="token punctuation">,</span>
        <span spellcheck="true" class="token comment">// 在這個 connection 依照時間排序時，把這個 ship 附加到前端</span>
        <span class="token string">&#x27;orderby(newest)&#x27;</span><span class="token punctuation">:</span> <span class="token string">&#x27;prepend&#x27;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span spellcheck="true" class="token comment">/* ... */</span>
<span class="token punctuation">}</span></pre><h3><a class="anchor" name="range-delete"></a><code>RANGE_DELETE</code> <a class="hash-link" href="#range-delete">#</a></h3><p>給定一個 parent、一個 connection、一個以上在回應 payload 中的 DataID，和 一個 parent 和 connection 之間的 path，Relay 會從這個 connection 移除這些 node，但把相關的 record 留在 store 中。</p><h4><a class="anchor" name="range-delete"></a>參數 <a class="hash-link" href="#range-delete">#</a></h4><ul><li><p><code>parentName: string</code></p><p>在回應中代表這個 connection 的 parent 的欄位名稱</p></li><li><p><code>parentID?: string</code></p><p>包含這個 connection 的 parent node 的 DataID。Omit if the parent node does not 有 ID。</p></li><li><p><code>connectionName: string</code></p><p>在回應中代表這個 connection 的欄位名稱</p></li><li><p><code>deletedIDFieldName: string | Array&lt;string&gt;</code></p><p>在回應中包含被移除的 node 的 DataID 的欄位名稱，或到從這個 connection 被移除的 node 的 path</p></li><li><p><code>pathToConnection: Array&lt;string&gt;</code></p><p>一個包含 parent 和 connection 之間的欄位名稱的陣列，包括 parent 和 connection</p></li></ul><h4><a class="anchor" name="range-delete"></a>範例 <a class="hash-link" href="#range-delete">#</a></h4><pre class="prism language-javascript">
<span class="token keyword">class</span> <span class="token class-name">RemoveTagMutation</span> <span class="token keyword">extends</span> <span class="token class-name">Relay<span class="token punctuation">.</span>Mutation</span> <span class="token punctuation">{</span>
  <span spellcheck="true" class="token comment">// 這個 mutation 宣告一個依賴關係在</span>
  <span spellcheck="true" class="token comment">// 被移除 tag 的那個 todo 上。</span>
  <span class="token keyword">static</span> fragments <span class="token operator">=</span> <span class="token punctuation">{</span>
    todo<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> Relay<span class="token punctuation">.</span>QL<span class="token template-string"><span class="token string">`fragment on Todo { id }`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span spellcheck="true" class="token comment">// 從一個 todo 移除一個 tag 會影響它的 tags connection</span>
  <span spellcheck="true" class="token comment">// 所以我們在這裡指定它作為 fat query 的一部份。</span>
  <span class="token function">getFatQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Relay<span class="token punctuation">.</span>QL<span class="token template-string"><span class="token string">`
      fragment on RemoveTagMutationPayload {
        todo { tags },
        removedTagIDs,
      }
    `</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">getConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> <span class="token string">&#x27;RANGE_DELETE&#x27;</span><span class="token punctuation">,</span>
      parentName<span class="token punctuation">:</span> <span class="token string">&#x27;todo&#x27;</span><span class="token punctuation">,</span>
      parentID<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>todo<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      connectionName<span class="token punctuation">:</span> <span class="token string">&#x27;tags&#x27;</span><span class="token punctuation">,</span>
      deletedIDFieldName<span class="token punctuation">:</span> <span class="token string">&#x27;removedTagIDs&#x27;</span><span class="token punctuation">,</span>
      pathToConnection<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#x27;todo&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;tags&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span spellcheck="true" class="token comment">/* ... */</span>
<span class="token punctuation">}</span></pre><h3><a class="anchor" name="required-children"></a><code>REQUIRED_CHILDREN</code> <a class="hash-link" href="#required-children">#</a></h3><p><code>REQUIRED_CHILDREN</code> 設定用來把額外的 children 附加到 mutation query 上。你可能會需要使用這個，例如，要抓取在一個 mutation 建立的新物件上的欄位 (而那是 Relay 通常不會嘗試去抓取的，因為它先前沒有為那個物件抓取任何東西)。</p><p>因為 <code>REQUIRED_CHILDREN</code> 設定而被抓取的資料不會被寫入客戶端的 store，不過你可以在傳遞進去 <code>commitUpdate()</code> 的 <code>onSuccess</code> callback 添加對其處理的程式碼：</p><pre class="prism language-javascript">
<span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>relay<span class="token punctuation">.</span><span class="token function">commitUpdate</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">CreateCouponMutation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    onSuccess<span class="token punctuation">:</span> response <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      couponCount<span class="token punctuation">:</span> response<span class="token punctuation">.</span>coupons<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><h4><a class="anchor" name="required-children"></a>參數 <a class="hash-link" href="#required-children">#</a></h4><ul><li><code>children: Array&lt;RelayQuery.Node&gt;</code></li></ul><h4><a class="anchor" name="required-children"></a>範例 <a class="hash-link" href="#required-children">#</a></h4><pre class="prism language-javascript">
<span class="token keyword">class</span> <span class="token class-name">CreateCouponMutation</span> <span class="token keyword">extends</span> <span class="token class-name">Relay<span class="token punctuation">.</span>Mutation</span><span class="token operator">&lt;</span>Props<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">getMutation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Relay<span class="token punctuation">.</span>QL<span class="token template-string"><span class="token string">`mutation {
      create_coupon(data: $input)
    }`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getFatQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Relay<span class="token punctuation">.</span>QL`
      <span spellcheck="true" class="token comment">// 注意，在這裡使用 `pattern: true` 來表示這個</span>
      <span spellcheck="true" class="token comment">// connection 欄位只用於模式匹配</span>
      <span spellcheck="true" class="token comment">// (以決定要抓取什麼) 所以 Relay 不應該</span>
      <span spellcheck="true" class="token comment">// 要求平常的 connection 參數像是 (`first` 等等)</span>
      <span spellcheck="true" class="token comment">// 存在。</span>
      fragment on CouponCreatePayload @<span class="token function">relay</span><span class="token punctuation">(</span>pattern<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        coupons
      <span class="token punctuation">}</span>
    `<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span spellcheck="true" class="token comment">// 如果我們在這個 mutation 執行的時候</span>
      <span spellcheck="true" class="token comment">// 尚未在 UI 上顯示這些 coupons，它們尚未被抓取過而且</span>
      <span spellcheck="true" class="token comment">// 在 fat query 中的 `coupons` 欄位通常會被忽略。</span>
      <span spellcheck="true" class="token comment">// `REQUIRED_CHILDREN` 則會強迫無論如何去取回它。</span>
      type<span class="token punctuation">:</span> RelayMutationType<span class="token punctuation">.</span>REQUIRED_CHILDREN<span class="token punctuation">,</span>
      children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        Relay<span class="token punctuation">.</span>QL<span class="token template-string"><span class="token string">`
          fragment on CouponCreatePayload {
            coupons
          }
        `</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre><h2><a class="anchor" name="optimistic"></a>Optimistic 更新 <a class="hash-link" href="#optimistic">#</a></h2><p>目前為止，我們執行過所有的 mutation 都有在更新客戶端的 store 之前等待從伺服器來的回應。Relay 提供一個機會給我們基於我們預期在 mutation 成功的情況下伺服器的回應會是什麼，去精巧的製作一個相同形狀的 optimistic 回應。</p><p>讓我們來為上面的 <code>LikeStoryMutation</code> 範例精巧的製作一個 optimistic 回應：</p><pre class="prism language-javascript">
<span class="token keyword">class</span> <span class="token class-name">LikeStoryMutation</span> <span class="token keyword">extends</span> <span class="token class-name">Relay<span class="token punctuation">.</span>Mutation</span> <span class="token punctuation">{</span>
  <span spellcheck="true" class="token comment">/* ... */</span>
  <span spellcheck="true" class="token comment">// 這是從前面來的 fat query</span>
  <span class="token function">getFatQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Relay<span class="token punctuation">.</span>QL<span class="token template-string"><span class="token string">`
      fragment on LikeStoryPayload {
        story {
          likers {
            count,
          },
          likeSentence,
          viewerDoesLike,
        },
      }
    `</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span spellcheck="true" class="token comment">// 讓我們來精巧的製作一個模仿 LikeStoryPayload 形狀</span>
  <span spellcheck="true" class="token comment">// ，以及我們預期接收到的值的 optimistic 回應。</span>
  <span class="token function">getOptimisticResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      story<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        id<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>story<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        likers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>story<span class="token punctuation">.</span>likers<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>story<span class="token punctuation">.</span>viewerDoesLike <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        viewerDoesLike<span class="token punctuation">:</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>story<span class="token punctuation">.</span>viewerDoesLike<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span spellcheck="true" class="token comment">// 要能夠去增加 likers 的 count，以及切換 viewerDoesLike</span>
  <span spellcheck="true" class="token comment">// ，我們需要確保這些資料可以讓這個 mutation</span>
  <span spellcheck="true" class="token comment">// 取用，還有 story 的 ID。</span>
  <span class="token keyword">static</span> fragments <span class="token operator">=</span> <span class="token punctuation">{</span>
    story<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> Relay<span class="token punctuation">.</span>QL<span class="token template-string"><span class="token string">`
      fragment on Story {
        id,
        likers { count },
        viewerDoesLike,
      }
    `</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span spellcheck="true" class="token comment">/* ... */</span>
<span class="token punctuation">}</span></pre><p>你不需要模擬完整的回應 payload。在這裡，我們把 like sentence 踢到一邊，因為要在客戶端上處理在地化很困難。當伺服器回應時，Relay 會把它的 payload 當作真相來源，不過在這期間，這個 optimistic 回應會立刻被套用，讓使用我們產品的人們能在做了一個動作後享受立即的回饋。</p></div><div class="docs-prevnext"><a class="docs-next" href="guides-network-layer.html#content">Next →</a></div></div></section><footer class="wrap"><div class="right">©2016 Facebook Inc.</div></footer></div><div id="fb-root"></div><script>
            !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
              ga('create', 'UA-71174216-1', 'auto');
              ga('send', 'pageview');
          </script></body></html>